---
- name: Install HashiCorp Vault on RHEL
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    vault_version: "1.18.3"
    vault_rpm_url: "https://releases.hashicorp.com/vault/{{ vault_version }}/vault-{{ vault_version }}-1.x86_64.rpm"

  tasks:

    - name: Download Vault RPM directly
      ansible.builtin.get_url:
        url: "{{ vault_rpm_url }}"
        dest: "/tmp/vault-{{ vault_version }}.rpm"
        mode: '0644'
      register: vault_download

    - name: Install Vault from RPM
      ansible.builtin.dnf:
        name: "/tmp/vault-{{ vault_version }}.rpm"
        state: present
        disable_gpg_check: no

    - name: Verify vault installation
      ansible.builtin.command:
        cmd: vault --version
      register: vault_version_output
      changed_when: false

    - name: Print vault version
      ansible.builtin.debug:
        msg: "Vault version: {{ vault_version_output.stdout }}"

    - name: Clean up downloaded RPM
      ansible.builtin.file:
        path: "/tmp/vault-{{ vault_version }}.rpm"
        state: absent
